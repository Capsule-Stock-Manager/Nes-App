<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nespresso è† å›Šç®¡å®¶</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QZ7E6ZT2Z6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QZ7E6ZT2Z6');
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-user-select: none; user-select: none; padding-bottom: 80px; }
        
        /* è† å›Šè‰²ç¥¨ç‰†æ¨£å¼ */
        .capsule-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 10px; background: white; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .capsule-btn { 
            aspect-ratio: 1; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            position: relative; 
            transition: transform 0.1s;
            border: 2px solid transparent;
        }
        .capsule-btn:active { transform: scale(0.9); }
        .capsule-btn.active { border-color: #198754; box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.2); transform: scale(1.1); z-index: 1; }
        .capsule-btn.active::after { content: 'âœ“'; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 14px; }
        .capsule-name { font-size: 9px; text-align: center; margin-top: 4px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        
        /* é£Ÿè­œå¡ç‰‡ */
        .recipe-card { border: none; border-radius: 12px; background: white; transition: 0.2s; margin-bottom: 10px; overflow: hidden; }
        .recipe-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .recipe-body { padding: 0 12px 12px 12px; font-size: 13px; color: #666; }
        .recipe-match { background-color: #e8f5e9; color: #198754; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        /* å¿«é€Ÿå¥—è£æŒ‰éˆ• */
        .quick-group-btn { font-size: 11px; padding: 4px 10px; border-radius: 20px; white-space: nowrap; border: 1px solid #ddd; background: white; color: #555; }
        .quick-group-btn:active { background: #eee; }

        /* æ•ˆæœŸæ¨™ç±¤ (åœ¨è‰²ç¥¨ä¸Š) */
        .expiry-dot { position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: #dc3545; border-radius: 50%; border: 1px solid white; }
        
        .sticky-header { position: sticky; top: 0; z-index: 100; background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(5px); padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="app" class="container py-3" style="max-width: 500px;">
    
    <div class="sticky-header">
        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
            <h5 class="fw-bold mb-0">â˜• è† å›Šç®¡å®¶ <span class="badge bg-secondary" style="font-size: 10px;">v9.0</span></h5>
            <button @click="showSync = !showSync" class="btn btn-sm btn-light text-muted">âš™ï¸ è¨­å®š</button>
        </div>

        <div class="d-flex justify-content-center mb-2">
            <div class="btn-group btn-group-sm shadow-sm rounded-pill overflow-hidden">
                <button class="btn px-4" :class="system === 'OL' ? 'btn-dark' : 'btn-outline-secondary border-0 bg-white'" @click="system = 'OL'">Original</button>
                <button class="btn px-4" :class="system === 'VL' ? 'btn-dark' : 'btn-outline-secondary border-0 bg-white'" @click="system = 'VL'">Vertuo</button>
            </div>
        </div>

        <div class="d-flex gap-2 overflow-auto pb-1 px-1" style="scrollbar-width: none;">
            <button class="quick-group-btn" @click="toggleAll(true)">âœ… å…¨é¸</button>
            <button class="quick-group-btn" @click="toggleAll(false)">ğŸ—‘ï¸ æ¸…ç©º</button>
            <div style="width: 1px; background: #ddd; margin: 0 4px;"></div>
            <button class="quick-group-btn" v-for="(list, cat) in currentCapsuleDB" :key="cat" @click="addCategory(list)">
                â• {{ cat.split(' ')[0] }}
            </button>
        </div>
    </div>

    <div class="mb-4">
        <small class="text-muted ms-2 mb-1 d-block" style="font-size: 11px;">é»æ“Šé¸å– (ç¶ è‰²=æœ‰) / é•·æŒ‰è¨­å®šæ•ˆæœŸ</small>
        <div class="capsule-grid">
            <div v-for="capName in flatCapsuleList" :key="capName" class="d-flex flex-column align-items-center" style="width: 100%;">
                <div class="capsule-btn shadow-sm" 
                     :class="{active: hasCapsule(capName)}"
                     :style="{ backgroundColor: getCapsuleColor(capName) }"
                     @click="toggleCapsule(capName)"
                     @contextmenu.prevent="openExpiryModal(capName)"> <div v-if="getExpiryStatus(capName)" class="expiry-dot"></div>
                </div>
                <div class="capsule-name">{{ capName }}</div>
            </div>
        </div>
    </div>

    <div v-if="capsules.length > 0">
        <h6 class="fw-bold px-2 mb-2">ğŸ¹ ä¾æ‚¨çš„åº«å­˜æ¨è–¦ ({{ matchedRecipes.length }})</h6>
        
        <div v-if="matchedRecipes.length === 0" class="text-center text-muted py-3 small bg-white rounded-3">
            é‚„æ²’æœ‰å®Œå…¨ç¬¦åˆçš„é£Ÿè­œï¼Œå†å¤šé¸å¹¾å€‹å£å‘³è©¦è©¦ï¼
        </div>

        <div v-for="recipe in matchedRecipes" :key="recipe.id" class="recipe-card shadow-sm">
            <div class="recipe-header" data-bs-toggle="collapse" :data-bs-target="'#rec-'+recipe.id">
                <div class="d-flex align-items-center gap-2">
                    <span style="font-size: 20px;">{{ recipe.icon }}</span>
                    <div>
                        <div class="fw-bold text-dark">{{ recipe.name }}</div>
                        <div class="recipe-match">ä½¿ç”¨ï¼š{{ recipe.matchCapsule }}</div>
                    </div>
                </div>
                <small class="text-muted">è©³æƒ… â–¼</small>
            </div>
            <div :id="'#rec-'+recipe.id" class="collapse recipe-body">
                <p class="mb-2">{{ recipe.desc }}</p>
                <div class="border-top pt-2">
                    <span class="badge bg-light text-dark border me-1" v-for="ing in recipe.ingredients">{{ ing }}</span>
                </div>
                <div v-if="getExpiryStatus(recipe.matchCapsule)" class="mt-2 text-danger small fw-bold">
                    âš ï¸ æ­¤è† å›Šè¨­å®šäº†æ•ˆæœŸï¼Œè«‹å„ªå…ˆé£²ç”¨ï¼
                </div>
            </div>
        </div>
    </div>
    
    <div v-else class="text-center py-5 text-muted">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ‘†</div>
        è«‹åœ¨ä¸Šæ–¹é»é¸æ‚¨æœ‰çš„è† å›Š<br>é£Ÿè­œæœƒè‡ªå‹•å‡ºç¾ï¼
    </div>

    <div v-if="showSync" class="card shadow border-0 position-fixed top-50 start-50 translate-middle p-3" style="width: 90%; max-width: 400px; z-index: 1000;">
        <h5 class="fw-bold mb-3">âš™ï¸ è³‡æ–™å‚™ä»½</h5>
        <textarea class="form-control mb-2" rows="3" readonly :value="backupCode" style="font-size: 10px;"></textarea>
        <button @click="copyBackup" class="btn btn-dark w-100 mb-3">è¤‡è£½å‚™ä»½ç¢¼</button>
        <hr>
        <h6 class="fw-bold">é‚„åŸè³‡æ–™</h6>
        <input v-model="restoreInput" class="form-control mb-2" placeholder="è²¼ä¸Šå‚™ä»½ç¢¼">
        <button @click="restoreData" class="btn btn-warning w-100">é‚„åŸ</button>
        <button @click="showSync = false" class="btn btn-link text-secondary w-100 mt-2">é—œé–‰</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    // è³‡æ–™åº«
    const CAPSULE_DB = {
        OL: { 
            "ç¾©å¼ç¶“å…¸": ["æ‹¿æ³¢é‡Œ", "å¡è–©", "èŠ®æ–¯å´”æœµ", "é˜¿ä½©å¥‡æ­", "ç¾…é¦¬", "å¨å°¼æ–¯", "è‰æ¢µæœµ", "å¡å¸ƒé‡Œå¥‡æ­", "æ²ƒé­¯æ‰˜", "ç§‘æ–¯"], 
            "ç’°éŠä¸–ç•Œ": ["é–‹æ™®æ•¦", "æ–¯å¾·å“¥çˆ¾æ‘©", "æ±äº¬", "ç¶­ä¹Ÿç´", "ä¸Šæµ·", "å¸ƒå®œè«¾æ–¯è‰¾åˆ©æ–¯", "å·´é»", "ä¼Šæ–¯å¦å ¡", "é‡Œç´„"], 
            "å–®ä¸€ç”¢å€": ["å°åº¦", "å°å°¼", "å“¥å€«æ¯”äº", "å°¼åŠ æ‹‰ç“œ", "ä¾ç´¢æ¯”äº"],
            "ç‰¹èª¿": ["æº«å’Œå¥‡é‡Œå¥§", "æ¿ƒé†‡è˜‡å…‹æ´›", "ç‰¹æ¿ƒå¯å¡”æœµ", "å¥¶æ²¹é¦™è‰", "ç„¦ç³–å¸ƒè•¾", "å¯å¯æ¾éœ²"] 
        },
        VL: { 
            "æ¿ƒç¸®": ["ç¾©å¼æ¿ƒç¸®", "è¿ªäºæ²ƒåˆ©æ‰˜", "é˜¿çˆ¾æç§€", "æ­æ‹‰è²æ­", "æ²ƒçˆ¾æ³°ç´¢"], 
            "é›™ä»½": ["é›™ä»½-ç‰¹æ¿ƒ", "é›™ä»½-æº«å’Œ", "é›™ä»½-ç”œå‘³"], 
            "å¤§æ¯": ["å°å¦ç´¢", "æ–¯æ‰˜ç±³æ­", "å¥§é”å¥‡æ­", "æ¢…çµ¡èŒ²æ­", "ç´¢è‰é‡Œæ­"],
            "é•·èƒ": ["èŠ™å¡”æœµ", "é˜¿éš†è¿ªæ­", "å› å°¼é½Šæ­", "å“¥æ–¯å¤§é»åŠ "],
            "ç‰¹èª¿": ["æ¯”æ˜‚ç§‘çš®ç§‘æ´›", "æ¯”æ˜‚ç§‘å¤šPIO", "æ¯”æ˜‚ç§‘é¦¥ç·¹", "ç”œé¦™è‰", "é‡‘é»ƒç„¦ç³–", "æ¿ƒé†‡å·§å…‹åŠ›", "çƒ¤æ¦›æœ"] 
        }
    };

    const RECIPES = [
        { id: 1, name: "ç¶“å…¸å†°æ‹¿éµ", icon: "ğŸ§Š", desc: "å†°å¡Š+ç‰›å¥¶+æ¿ƒç¸®", ingredients: ["å†°å¡Š", "150ml ç‰›å¥¶"], recommended: ["é˜¿ä½©å¥‡æ­", "é›™ä»½-ç‰¹æ¿ƒ", "ç¾…é¦¬", "æ‹¿æ³¢é‡Œ"] },
        { id: 2, name: "è¥¿è¥¿é‡Œæ°£æ³¡", icon: "ğŸ‹", desc: "æ°£æ³¡æ°´+æª¸æª¬+ç³–", ingredients: ["æ°£æ³¡æ°´", "æª¸æª¬æ±", "ç³–æ¼¿"], recommended: ["ç§‘æ–¯", "æ²ƒé­¯æ‰˜", "æ±äº¬", "ç´¢è‰é‡Œæ­"] },
        { id: 3, name: "ç„¦ç³–ç‘ªå¥‡æœµ", icon: "ğŸ®", desc: "ç†±å¥¶æ³¡+ç„¦ç³–é†¬", ingredients: ["ç„¦ç³–é†¬", "ç†±ç‰›å¥¶"], recommended: ["ç„¦ç³–å¸ƒè•¾", "é‡‘é»ƒç„¦ç³–", "æ²ƒé­¯æ‰˜"] },
        { id: 4, name: "é˜¿æ³•å¥‡æœµ", icon: "ğŸ¨", desc: "æ·‹åœ¨å†°æ·‡æ·‹ä¸Š", ingredients: ["é¦™è‰å†°æ·‡æ·‹"], recommended: ["å¯å¯æ¾éœ²", "æ¿ƒé†‡å·§å…‹åŠ›", "é˜¿ä½©å¥‡æ­"] },
        { id: 5, name: "ç†±ç¾å¼", icon: "â˜•", desc: "ç†±æ°´ç¨€é‡‹", ingredients: ["150ml ç†±æ°´"], recommended: ["é–‹æ™®æ•¦", "æ–¯æ‰˜ç±³æ­", "å¥§é”å¥‡æ­"] },
        { id: 6, name: "ç‡•éº¥æ‹¿éµ", icon: "ğŸŒ¾", desc: "æ­é…ç‡•éº¥å¥¶", ingredients: ["ç‡•éº¥å¥¶"], recommended: ["æº«å’Œå¥‡é‡Œå¥§", "ç‰¹æ¿ƒå¯å¡”æœµ", "æ¯”æ˜‚ç§‘é¦¥ç·¹"] },
        { id: 7, name: "æ‘©å¡å’–å•¡", icon: "ğŸ«", desc: "åŠ å·§å…‹åŠ›ç²‰", ingredients: ["å·§å…‹åŠ›ç²‰", "ç‰›å¥¶"], recommended: ["å¯å¯æ¾éœ²", "æ¿ƒé†‡å·§å…‹åŠ›", "å°å¦ç´¢"] },
        { id: 8, name: "é˜²å½ˆå’–å•¡", icon: "ğŸ›¡ï¸", desc: "åŠ å¥¶æ²¹èˆ‡MCTæ²¹", ingredients: ["ç„¡é¹½å¥¶æ²¹", "MCTæ²¹"], recommended: ["æ–¯æ‰˜ç±³æ­", "é–‹æ™®æ•¦", "æ‹¿æ³¢é‡Œ"] }
    ];

    createApp({
        setup() {
            const system = ref('OL');
            const capsules = ref([]); // æ ¼å¼: [{name: 'xxx', expiry: 'yyyy-mm-dd'}]
            const showSync = ref(false);
            const restoreInput = ref('');

            onMounted(() => {
                const saved = localStorage.getItem('nespresso_v9');
                if (saved) capsules.value = JSON.parse(saved);
            });

            watch(capsules, (val) => localStorage.setItem('nespresso_v9', JSON.stringify(val)), { deep: true });

            const currentCapsuleDB = computed(() => CAPSULE_DB[system.value]);
            const flatCapsuleList = computed(() => Object.values(currentCapsuleDB.value).flat());

            const hasCapsule = (name) => capsules.value.some(c => c.name === name);

            // åˆ‡æ›è† å›Š (é»æ“Š)
            const toggleCapsule = (name) => {
                const idx = capsules.value.findIndex(c => c.name === name);
                if (idx > -1) {
                    capsules.value.splice(idx, 1);
                } else {
                    capsules.value.push({ name, expiry: '' });
                }
            };

            // é•·æŒ‰è¨­å®šæ•ˆæœŸ
            const openExpiryModal = (name) => {
                const date = prompt(`è¨­å®šã€Œ${name}ã€çš„æ•ˆæœŸ (YYYY-MM-DD)\nç•™ç©ºå‰‡æ¸…é™¤`, "");
                if (date !== null) {
                    const cap = capsules.value.find(c => c.name === name);
                    if (cap) cap.expiry = date;
                    else capsules.value.push({ name, expiry: date });
                }
            };

            const getExpiryStatus = (name) => {
                const cap = capsules.value.find(c => c.name === name);
                return cap && cap.expiry ? true : false;
            };

            // å¿«é€Ÿå¥—è£æŒ‰éˆ•
            const addCategory = (list) => {
                list.forEach(name => {
                    if (!hasCapsule(name)) capsules.value.push({ name, expiry: '' });
                });
            };
            const toggleAll = (add) => {
                if (add) addCategory(flatCapsuleList.value);
                else capsules.value = capsules.value.filter(c => !flatCapsuleList.value.includes(c.name));
            };

            // é…å°é£Ÿè­œ
            const matchedRecipes = computed(() => {
                // æ‰¾å‡ºå¯ä»¥åšçš„é£Ÿè­œ
                const available = RECIPES.map(r => {
                    const match = r.recommended.find(recName => hasCapsule(recName));
                    return match ? { ...r, matchCapsule: match } : null;
                }).filter(r => r !== null);
                
                // å„ªå…ˆé¡¯ç¤ºæœ‰æ•ˆæœŸçš„è† å›Šå°æ‡‰é£Ÿè­œ
                return available.sort((a, b) => {
                    const aHasExpiry = getExpiryStatus(a.matchCapsule);
                    const bHasExpiry = getExpiryStatus(b.matchCapsule);
                    return bHasExpiry - aHasExpiry;
                });
            });

            // é¡è‰²é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
            const getCapsuleColor = (name) => {
                if(name.includes('é˜¿ä½©å¥‡æ­')) return '#382554';
                if(name.includes('æ‹¿æ³¢é‡Œ') || name.includes('èŠ®æ–¯å´”æœµ')) return '#222';
                if(name.includes('ç¾…é¦¬')) return '#555';
                if(name.includes('æ¢…çµ¡èŒ²æ­')) return '#d8b265';
                if(name.includes('å¯å¯') || name.includes('å·§å…‹åŠ›')) return '#483d8b';
                if(name.includes('ç„¦ç³–')) return '#b8860b';
                if(name.includes('é¦™è‰')) return '#f5deb3';
                if(name.includes('æ±äº¬')) return '#e6e6fa'; // æ·¡ç´«
                if(name.includes('é–‹æ™®æ•¦')) return '#cd853f';
                if(name.includes('æ–¯å¾·å“¥çˆ¾æ‘©')) return '#006400';
                return '#888'; // é è¨­ç°
            };

            // å‚™ä»½åŠŸèƒ½
            const backupCode = computed(() => btoa(encodeURIComponent(JSON.stringify(capsules.value))));
            const copyBackup = () => navigator.clipboard.writeText(backupCode.value).then(() => alert('å·²è¤‡è£½!'));
            const restoreData = () => {
                try {
                    capsules.value = JSON.parse(decodeURIComponent(atob(restoreInput.value)));
                    alert('é‚„åŸæˆåŠŸ!'); showSync.value = false;
                } catch(e) { alert('ç„¡æ•ˆä»£ç¢¼'); }
            };

            return { system, capsules, currentCapsuleDB, flatCapsuleList, hasCapsule, toggleCapsule, openExpiryModal, getExpiryStatus, addCategory, toggleAll, matchedRecipes, getCapsuleColor, showSync, backupCode, copyBackup, restoreData, restoreInput };
        }
    }).mount('#app');
</script>
</body>
</html>
